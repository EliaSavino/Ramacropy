# PyMMC
 Python package to handle MMC data for course 2022/2023

## Scope of the Package
Dear Student of MMC practical 2022/2023, as you TA, I highly encourge (read as: require you) to use Python to clean up, analyse and plot the data you have gathered for the Raman experiment of this course. However, it would be too time consuming for all of you to write your own scripts, and it would take away your focus from the core concepts of the course. After all this is a macromolecular chemistry course not an introduction to Python one. Therefore, I wrote you a neat little package that you can use to read the data in CSV files read from the experiments and perform data processing (baselining, normalisation, noise reduction and cosmic removal), data analysis (integrals and center of mass) and data plotting (single spectra, spectra over time, integral over time). This way when I read your reports what you will get judged on is your scientific, critical analysis, and writing skills (or lack thereof) and not your ability to use Excel.

You are of course allowed to not use this package and write your own, modify it or do anything else with it (open source with MIT licence). For data processing/analysis you can, if you prefer use Spectragryph on the UPV. However, screenshots of your UPV will not help your grades, so take care that the plots you present look good and make sense. 
My legal team has notified me that I technically cannot force you to use python, here's a few alternatives that are also accepted: Matlab, Javascript, Julia, C++(good luck with this one) or whitespace. Excel is also allowed(not recommended) but please take care that your plots don't look disgusting and actually provide all the information needed. 

**_For questions and debugging issues (with limitations) I'm available at e.savino@rug.nl_**

## System Reqirements
No environment or Python executable is provided for this package. You are responsible for having Python 3 installed on your machine and a way to manage your packages. I recommend using a combination of Pip and Conda for your package and environment management. If you don't know how to do this, please refer to the Python documentation. If you are unfamiliar with Python, start by defining a computer and working your way forward.

The following packages are required:

Matplotlib
NumPy
Pandas
SciPy
sif_parser (which you can download with pip install sif_parser). All rights reserved to https://github.com/fujiisoup.

## Documentation
This documentation not only provides instructions on how to effectively use this package, but also offers guidance on handling Raman data in the best (to the best of my knowledge) practice manner.

### Importing the package
Ensure that you have the 'Ramacropy' folder in your working directory and add the following code to your script:
```python
from Ramacropy.Ramacropy import Spectra
```
Please do not make changes to the code within the 'Ramacropy' folder, as doing so may cause issues with its functionality. Instead, simply import and use the package in your own script


### Loading data
If you have data in a sif file from the lab, place it in your working directory (or in a subdirectory). You can load it into Python using the following code:
```python
my_spec = Spectra('Path/to/file.sif', laser_wavelength=785.0)
```
This script is capable of reading sif files from Andor spectrometers, as well as .pkl and .csv files generated by this script and the .csv files provided by the course Coordinator. The laser_wavelength parameter defaults to 785 nm (as that's what we use in the lab), so only change it if a different laser was used.

### Data Strucuture
Once instantiated, you can access the following attributes of the 'my_spec' object:

- my_spec.RamanShift: The x-axis of your data, containing the shift at each y-point.
- my_spec.TimeStamp: The time data of each spectrum in the series.
- my_spec.SpectralData: The actual y-data of your file.
- my_spec.RawData: The same as SpectralData, but doesn't change if you perform processing (only for .pkl and .sif files).
- my_spec.SpectralInfo: This is the metadata from Andor (see sif_parser for more info, only for .pkl and .sif files).
- my_spec.directory: The original path to the file.
- my_spec.filelab: The original file name.

you don't need to do this, but you may want to. 
### Exploratory Plotting
Once the data is loaded, you should plot it to see what you are working with. you can do this in two ways, depending if your data is a kinetic series or a single spectrum.

for kinetic series use:
```python
my_spec.plot_kinetic()
```

you will get the follwing:
![Alt Text](./ReadmeIMG/Plot_rawKin.png)

for single spectra use: 

```python
my_spec.plot_few()
```

which yields: 
![Alt Text](./ReadmeIMG/Plot_rawSin.png)



### Data Processing
In data processing, it's often the case that less is more. The tools you have at your disposal include baseline correction, integration (by peak or by area), and spike removal. It's recommended that you first perform baseline correction, followed by normalization, and then spike removal (only if you have a lot of spikes).

By performing baseline correction, you can remove any sloping baseline from your data, making it easier to identify and analyze peaks. Normalization can help to account for any differences in signal intensity between spectra, making it easier to compare and analyze data across multiple spectra. Finally, spike removal can help to eliminate any anomalous data points that may skew your results.

Remember, when it comes to data processing, it's important to strike a balance between removing noise and preserving important information. Be mindful of the potential impact that each processing step may have on your data, and consider the trade-offs carefully.

#### Baseline correction
The baseline correction function has three parameters: coarseness, angle, and offset. Coarseness is an indication of how straight your baseline is, angle determines the angle of the baseline, and offset determines how far up or down you need the baseline to be. If you're not sure what values to use (and I suggest you do this every time you have a new piece of data), you can run the baseline routine interactively.

By running the baseline routine interactively, you can visually inspect the results and adjust the parameters as needed to achieve the desired baseline correction. This can help you to fine-tune the parameters and get the best possible results.

Remember, when performing baseline correction, it's important to be mindful of the potential impact that this processing step may have on your data. Be sure to carefully evaluate the results to ensure that the baseline correction is appropriate and does not introduce any unwanted artifacts or distortions.

if you know what parameters you need:

```python
my_spec.baseline(coarsness=0.3, angle = 12, offset = 300)
```

if you don't know you can use:

```python
my_spec.baseline(interactive = True)
```
and you'll get the following interactive plot:
![Alt Text](./ReadmeIMG/Baseline_int1.png)

adjust the sliders until you get a baseline that looks satisfactory, like so:
![Alt Text](./ReadmeIMG/Baseline_int2.png)

To apply the baseline correction to your spectra, click the 'Try' button. If you want to start over, click the 'Reset' button. Once you're satisfied with the correction, click the 'Done' button to confirm.

#### Normalisation
The normalization method is similar to baseline correction, but instead of removing a sloping baseline, you're adjusting the intensity of the spectra to account for any differences in signal intensity. To perform normalization, you first have to decide which method to use, either 'area' or 'peak'. The choice is yours, and depends on the specifics of your data.

Once you've selected a method, you can apply it to your data and visually inspect the results. If you're not sure where to put your bounds or peak, you can run the normalization routine interactively. This allows you to fine-tune the parameters and achieve the desired normalization.


for area:
```python
my_spec.normalise(method='area',start=700.0,end = 750.0)
```
where start and end are the bounds of your normalisation in Raman shift (cm<sup>-1</sup>)
for peak:
```python
my_spec.normalise(method='peak',peak=700.0)
```
if you decide to run interactively, you can do, for area:
```python
my_spec.normalise(method='area',interactive=True)
```
which will open the following window:
![Alt Text](./ReadmeIMG/normalise_area.png)

use the sliders to decide your bounds of integration, the buttons do what explained previously.

for interactive peak use:
```python
my_spec.normalise(method='peak',interactive=True)
```
which will open the following:
![Alt Text](./ReadmeIMG/normalise_peak.png)

use the slider to choose your peak position, and use the buttons to apply, reset or confirm

#### Spike removal
It can happen that the sensor in the spectrometer picks up random cosmic rays passing through it, this show up in the spectra as "cosmics", or spikes, you can recognise them as they are very thin, only last 1 spectrum, and change without any recognisable pattern.
To attempt at removing them you can use, 
```python
my_spec.spike_removal()
```

if it doesn't remove them all, it's fine. just ignore them, (acknowledge this in your analysis)

### Data saving
CCongratulations, you've now completed your data processing! Before we move on to discussing data analysis, let's talk about how to save your data.

You can save your data as a .pkl file, which is a binary file that saves all the information in your data (raw data, processed data, time stamps, spectrometer conditions, etc.), but is not human-readable (this is the default). Alternatively, you can save your data in a human-readable CSV format. To save your data, use the following code:
```python
#in binary format
my_spec.save_changes(dirpath = 'My/Directory', filename = 'NameFile.pkl')
#in csv format
my_spec.save_changes(dirpath = 'My/Directory', filename = 'NameFile.csv')
```
The **dirpath** and **filename** arguments are optional. If the dirpath argument is missing, the **save_changes()** function will save the file in the same directory as the original file. If the filename argument is missing, the function will save a .pkl file with the same name as the original file.
It's recommended that you explicitly specify the dirpath and filename arguments to avoid any potential confusion or unintended overwriting of existing files.

BE CAREFUL, THIS WILL OVERWRITE FILES WITHOUT WARNING YOU!!! (you have been warned)

the files generated with this command can be opened with this program (check above)

Remember, it's a good practice to save your data at various stages of processing to avoid having to repeat time-consuming processing steps if you need to revisit your analysis later on.

### Data analysis
You are provided with one method of data analysis, which is integration. However, you are also encouraged(read as required) to use your common sense and intuition to gain a deeper understanding of your spectra and the information they contain. Be mindful that integration, much like any tool, is only as good as the craftsman. 

#### Integration
Integration calculates the area of your spectrum within certain bounds. The code works exactly as the normalisation by area, 
you can run it either by passing the bounds of integration, or interactively. 

if you choose to run this interactive:
```python
my_spec.integrate(interactive=True)
```

which will give this window: 
![Alt Text](./ReadmeIMG/Integral.png)

Use the sliders to select the integration area, the calculate button calculates the integral, and the reset button, resets the sliders.

if you already know your integration bounds you can use:
```python
my_spec.integrate(start = 850.0, end = 1000.0)
```
where the start and end are the bounds for the integration.

### Plotting your analysis
Now we get to the fun part. Once you have itegrated and processed your spectra you need to plot them and put them in your report. You are provided with the follwing tools: 
- plotting a kinetic run
- plotting one single spectrum, or a comparison of a few spectra
- plotting the trace of the integral (or conversion) of a kinetic run, or a comparison of kinetic run traces.
- plotting the integral of a single specrum, or a comparison of a few spectra.


#### Kinetic series of spectra
this command we have already seen:
```python
my_spec.plot_kinetic()
```

#### Plot a single spectrum, or a comparison

you can plot a single spectrum with:
```python
my_spec.plot_few(labels=['my_label'])
```
the labels argument is a list of the labels you want the legend of the spectra to display. If you omit it, it will default to the filename

now imagine you have instantiated the follwing:
```python
before_spectrum = Spectra('Data/Processed_Before.pkl')
after_spectrum = Spectra('Data/Processed_After.csv')
```
the Spectra must have been integrated already (with spec.integrate)

you can plot them toghether with:
```python
before_spectrum.plot_few(other_spectra=[after_spectrum],labels = ['Before','After'])
```
and you'll get something like this:
![Alt Text](./ReadmeIMG/Analysis_few.png)

From here you can discuss what happens in your spectra. (of course you can zoom on a part in matplotlib. Weird cutouts from the jpeg will not be accepted. Keep it neat)

#### Plot a kinetic trace or a comparison
To plot a trace of the integral over time use:
```python
my_spec.plot_integral_kinetic()
```
or 

```python
my_spec.plot_integral_kinetic(conversion=True)
```

to get: 
![Alt Text](./ReadmeIMG/Kinetic_single_int.png)

or 
![Alt Text](./ReadmeIMG/Kinetic_single_conv.png)


you can use the argument labels = ['mylabel'] as before to change the name in the legend.

now again imagine that you have the follwing sets of data, that has previously been processed and integrated

```python
before_spectrum = Spectra('Data/Processed_Kinetic_B.pkl')
after_spectrum = Spectra('Data/Processed_Kinetic_A.csv')
```

you can plot the two traces toghether with:
```python
before_specrrum.plot_integral_kinetic(other_spectra=[after_spectrum],labels=['Before','After'])
```
yielding: 
![Alt Text](./ReadmeIMG/Kinetic_int.png)

you can use the conversion parameter to show conversion instead

#### plotting the integral or the comparison of integrals 

see the plotting_few spectra, but with plotting_integral_single

you will get this:
![Alt Text](./ReadmeIMG/Int_few.png)


##Final notes
This is the documentation for this. It should not break, but if it does please get in contact with me. Good luck!

there is an example of use in Example.py




